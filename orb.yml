version: 2.1
description: OpenVPN client Orb
display:
  home_url: https://aws.amazon.com/s3/
  source_url: https://github.com/jamiefiedler/openvpn-orb

executors:
  default:
    description: |
      "AWS Client VPN via mutual authentication certificates."
#    machine: true
    machine:
      image: ubuntu-1604:201903-01

commands:
  install:
    description: "Install OpenVPN client"
    steps:
      - run:
          name: Install OpenVPN
          command: |
            sudo sh -c "curl -s https://swupdate.openvpn.net/repos/repo-public.gpg | apt-key add -"
            sudo sh -c 'echo "deb http://build.openvpn.net/debian/openvpn/stable xenial main" > /etc/apt/sources.list.d/openvpn-aptrepo.list'
            sudo apt-get -q -y update
            sudo apt-get -q -y install openvpn
  connect:
    description: "Connect to OpenVPN"
    parameters:
      config:
        description: |
          "ENV var name containing OpenVPN client .ovpn config file content base64 encoded"
        type: env_var_name
        default: VPN_CONFIG
      login:
        description: |
          "ENV var name containing OpenVPN newline separated username and password base64 encoded"
        type: env_var_name
        default: VPN_LOGIN
    steps:
      - run:
          name: Initialize VPN
          command: |
            echo ${<<parameters.config>>:?} | base64 --decode >> config.ovpn
      - when:
          condition: << parameters.login >>
          steps:
            - run:
                name: Set credentials for auth-user-pass
                command: |
                  echo ${<<parameters.login>>:-""} | base64 --decode >> vpn.login
      - run:
          name: Connect VPN
          command: |
            ovpn_params=()
            if [ -s vpn.login ]
            then
                ovpn_params+=(--auth-user-pass vpn.login)
            fi
            wget -qO- http://checkip.amazonaws.com > initial.ip
            sudo openvpn --config config.ovpn "${ovpn_params[@]}" > openvpn.log 2>&1 &
            while [ -n "$(ip addr show tun0 2>&1 > /dev/null)" ]; do
              sleep 0.1;
            done
            cat openvpn.log
  disconnect:
    description: "Disconnect from OpenVPN"
    steps:
      - run:
          name: Disconnect VPN
          command: sudo killall openvpn || true
      - run:
          name: Remove OpenVPN config
          command: sudo rm config.ovpn

example:
  secure-ping:
    description: "Establish VPN connection and execute a command within it"
    usage:
      version: 2.1
      orbs:
        vpn: jamiefiedler/aws-clientvpn
      jobs:
        ping:
          executor: vpn/default
          steps:
            - vpn/install
            - vpn/connect
            - run: ping -c 5 192.0.2.1
            - vpn/disconnect
